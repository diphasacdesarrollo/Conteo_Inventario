{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Conteo — Grupo {{ grupo }} | Conteo N° {{ conteo }}</title>
  <link rel="stylesheet" href="{% static 'inventario/css/estilos.css' %}">
  <style>
    .page { max-width: 1180px; margin: 18px auto; padding: 16px; }

    .toolbar {
      display: flex; gap: 12px; align-items: end; flex-wrap: wrap;
      margin: 10px 0 12px;
    }
    .toolbar label { font-weight: 600; display: block; margin-bottom: 6px; }
    select { padding: 8px; border-radius: 6px; border: 1px solid #cfd4da; min-width: 160px; }
    .btn {
      background: #0d6efd; color: #fff; border: 0; padding: 9px 14px;
      border-radius: 6px; cursor: pointer; font-weight: 600;
    }
    .btn.secondary { background: #6c757d; }
    .btn.warn { background: #495057; }
    .btn:hover { filter: brightness(0.95); }

    .actions-row { display: flex; gap: 10px; margin: 6px 0 12px; flex-wrap: wrap; }

    .table-wrap {
      border: 1px solid #e7e7e7; border-radius: 10px; overflow: hidden;
      background: #fff;
    }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      position: sticky; top: 0;
      background: #0d6efd; color: #fff;
      text-align: center;
      font-weight: 700; font-size: 14px;
      padding: 12px 10px; letter-spacing: .2px;
    }
    tbody td {
      border-top: 1px solid #eef1f4;
      padding: 10px; text-align: center; font-size: 14px;
    }
    tbody tr:nth-child(even) { background: #f8fafc; }
    td.prod { text-align: left; font-weight: 600; }
    td.prod small { color: #6c757d; font-weight: 400; }

    .qty { width: 120px; padding: 8px; border: 1px solid #cfd4da; border-radius: 6px; text-align: right; }

    .cell-eq { width: 60px; }
    .btn-eq {
      width: 40px; height: 36px; border-radius: 8px; border: 1px solid #d0d6dd;
      background: #f1f3f5; cursor: pointer; font-weight: 700;
    }

    .panel { margin-top: 22px; }
    .panel h3 { margin: 0 0 10px; }
    .w-100 { width: 100%; }
    .textarea { width: 100%; min-height: 90px; padding: 10px; border: 1px solid #cfd4da; border-radius: 8px; }

    .top-right { float: right; margin-top: 0; }
    .link-btn {
      background: transparent; color: #0d6efd; border: 1px solid #d0d6dd;
      padding: 8px 12px; border-radius: 8px; cursor: pointer;
    }

    /* ayuda visual de cabeceras */
    .col-prod   { width: 44%; }
    .col-lote   { width: 16%; }
    .col-alm    { width: 16%; }
    .col-cont   { width: 16%; }
    .col-acc    { width: 8%;  }

  </style>
</head>
<body>
<div class="page">

  <div class="top-right">
    <a href="{% url 'seleccionar_grupo' %}" class="link-btn">Volver a selección</a>
  </div>

  <h2>Conteo — <b>Grupo {{ grupo }}</b> | <b>Conteo N° {{ conteo }}</b></h2>
  <p style="margin-top:-6px;color:#6c757d">Selecciona Zona/Subzona y registra las cantidades contadas.</p>

  <!-- Filtro de zona/subzona (GET) -->
  <form method="get" action="{% url 'conteo_producto' %}">
    <div class="toolbar">
      <div>
        <label for="zona">Zona:</label>
        <select name="zona" id="zona" required>
          <option value="">— Selecciona —</option>
          {% for z in zonas %}
            <option value="{{ z.id }}" {% if z.id == zona_seleccionada %}selected{% endif %}>{{ z.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="subzona">Subzona:</label>
        <select name="subzona" id="subzona" required>
          <option value="">— Selecciona —</option>
          {% for s in subzonas %}
            <option value="{{ s.id }}" {% if s.id == subzona_seleccionada %}selected{% endif %}>{{ s.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <button class="btn" type="submit">Buscar productos</button>
      </div>
    </div>
  </form>

  {% if inventario %}
  <!-- Form de conteo (POST) -->
  <form method="post" action="{% url 'conteo_producto' %}">
    {% csrf_token %}

    <div class="actions-row">
      <button type="button" id="btnFillAll" class="btn secondary">Igualar todo a “Cantidad en Almacén”</button>
      <button type="button" id="btnZeroAll" class="btn warn">Poner 0 en todos</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="col-prod">Producto</th>
            <th class="col-lote">Lote</th>
            <th class="col-alm">Cantidad en Almacén</th>
            <th class="col-cont">Cantidad Contada</th>
            <th class="col-acc">Acción</th>
          </tr>
        </thead>
        <tbody>
          {% for item in inventario %}
          <tr data-row-id="{{ item.id }}">
            <!-- SOLO nombre (código va como title por si quieres verlo al pasar el mouse) -->
            <td class="prod" title="Código: {{ item.codigo }}">{{ item.producto_nombre }}</td>
            <td>{{ item.lote }}</td>
            <td class="almacen" data-alm="{{ item.cantidad|floatformat:0 }}">{{ item.cantidad|floatformat:2 }}</td>
            <td>
              <input class="qty" type="number" step="1" min="0"
                     name="cantidad_contada_{{ item.id }}" value="">
            </td>
            <td class="cell-eq">
              <!-- Igualar esta fila -->
              <button type="button" class="btn-eq" title="Igualar a almacén">=</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="display:flex; justify-content:flex-end; margin-top:12px;">
      <button type="submit" class="btn">Registrar Conteo</button>
    </div>
  </form>
  {% endif %}

  {% if not inventario and zona_seleccionada and subzona_seleccionada %}
    <p style="color:#c1121f; margin-top:12px;">No se encontraron productos para esta ubicación.</p>
  {% endif %}

  <!-- Panel de incidencias -->
  <div class="panel">
    <h3>Reportar incidencia</h3>

    <form method="post" action="{% url 'registrar_comentario' %}">
      {% csrf_token %}

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <input id="buscar_producto" type="text" class="w-100"
               placeholder="Buscar producto..." autocomplete="off"
               style="max-width: 360px; padding: 8px; border-radius: 6px; border:1px solid #cfd4da;">
        <button type="button" id="btnUseInComment" class="btn secondary">Usar en comentario</button>
      </div>

      <div id="resultados_productos"
           style="border:1px solid #ddd; display:none; position:absolute; background:#fff; z-index:1000; max-width:360px;"></div>

      <textarea name="incidencia_comentario" class="textarea" placeholder="Describe la incidencia…"></textarea>

      <div style="margin-top:8px;">
        <button type="submit" class="btn">Registrar Comentario</button>
      </div>
    </form>
  </div>

  <div style="margin-top:16px; text-align:center;">
    <a href="{% url 'seleccionar_grupo' %}" class="link-btn">Salir y Seleccionar Otro Grupo</a>
  </div>

  {% if messages %}
  <div style="margin-top:12px;">
    {% for message in messages %}
      <div class="alert {{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}
</div>

<script>
  // Rellenar subzonas por AJAX al cambiar zona
  document.getElementById('zona').addEventListener('change', function () {
    const zona = this.value;
    const subSel = document.getElementById('subzona');
    subSel.innerHTML = '<option value="">— Cargando… —</option>';
    if (!zona) { subSel.innerHTML = '<option value="">— Selecciona —</option>'; return; }
    fetch('{% url "obtener_subzonas" %}?zona=' + encodeURIComponent(zona))
      .then(r => r.json())
      .then(({subzonas}) => {
        subSel.innerHTML = '<option value="">— Selecciona —</option>';
        subzonas.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id; opt.textContent = s.nombre;
          subSel.appendChild(opt);
        });
      });
  });

  // === Igualar todos / poner cero
  const btnFillAll = document.getElementById('btnFillAll');
  const btnZeroAll = document.getElementById('btnZeroAll');

  function eachRow(cb){
    document.querySelectorAll('tbody tr').forEach(cb);
  }

  if (btnFillAll) btnFillAll.addEventListener('click', () => {
    eachRow(tr => {
      const alm = tr.querySelector('.almacen').dataset.alm;
      const input = tr.querySelector('.qty');
      input.value = alm;
    });
  });

  if (btnZeroAll) btnZeroAll.addEventListener('click', () => {
    eachRow(tr => tr.querySelector('.qty').value = 0);
  });

  // Igualar por fila
  document.querySelectorAll('.btn-eq').forEach(btn => {
    btn.addEventListener('click', e => {
      const tr = e.target.closest('tr');
      const alm = tr.querySelector('.almacen').dataset.alm;
      tr.querySelector('.qty').value = alm;
    });
  });

  // === Autocomplete de productos para incidencia
  const inputBusqueda = document.getElementById('buscar_producto');
  const resultadosDiv = document.getElementById('resultados_productos');
  const btnUseInComment = document.getElementById('btnUseInComment');
  const textareaComentario = document.querySelector('textarea[name="incidencia_comentario"]');

  if (inputBusqueda) {
    inputBusqueda.addEventListener('input', function () {
      const query = this.value.trim();
      resultadosDiv.innerHTML = '';
      resultadosDiv.style.display = 'none';
      if (query.length < 2) return;

      fetch('{% url "buscar_productos" %}?q=' + encodeURIComponent(query))
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            resultadosDiv.style.display = 'block';
            resultadosDiv.style.maxHeight = '220px';
            resultadosDiv.style.overflowY = 'auto';
            resultadosDiv.style.padding = '4px';
            data.forEach(nombre => {
              const item = document.createElement('div');
              item.textContent = nombre;
              item.style.padding = '6px 8px';
              item.style.cursor = 'pointer';
              item.addEventListener('click', function () {
                inputBusqueda.value = nombre;
                resultadosDiv.innerHTML = '';
                resultadosDiv.style.display = 'none';
              });
              resultadosDiv.appendChild(item);
            });
          }
        });
    });

    document.addEventListener('click', function (e) {
      if (!inputBusqueda.contains(e.target) && !resultadosDiv.contains(e.target)) {
        resultadosDiv.style.display = 'none';
      }
    });

    if (btnUseInComment) {
      btnUseInComment.addEventListener('click', function () {
        if (inputBusqueda.value.trim()) {
          textareaComentario.value = inputBusqueda.value.trim() + (textareaComentario.value ? '\n' + textareaComentario.value : '');
          inputBusqueda.focus();
        }
      });
    }
  }
</script>
</body>
</html>
